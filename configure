#! /usr/bin/env bash
# Copyright (C) 2015-2015 Hack Stuff.
# Author : v1 <cmj@cmj.tw>
#

start=`date +%s`

check() {
	if [ x"$2" = x"" ]; then
		printf "Check %s not found\n" $1
		exit -1
	else
		printf "Checking for %-32s : %s \n" $1 $2
	fi
}
check_bin_else_exit() {
	BIN=$(which "$1" 2>/dev/null)
	check "$1" ${BIN}
}


check_bin_else_exit make
check_bin_else_exit iw
check_bin_else_exit crontab
check_bin_else_exit python2

INSTALL_TOOL=$(which apt-get 2>/dev/null || which pacman 2>/dev/null || which yum 2>/dev/null)
check install_tool ${INSTALL_TOOL}
if [ x"$(echo ${INSTALL_TOOL} | grep apt-get)" != x"" ]; then
	INSTALL="apt-get install"
	UPDATE="apt-get update"
	UPGRADE="apt-get upgrade"
elif [ x"$(echo ${INSTALL_TOOL} | grep pacman)" != x"" ]; then
	INSTALL="pacman -S"
	UPDATE="pacman -Sy"
	UPGRADE="pacman -Su"
elif [ x"$(echo ${INSTALL_TOOL} | grep yum)" != x"" ]; then
	INSTALL="yum install"
	UPDATE="yum -y update"
	UPGRADE="yum upgrade"
fi


## Generate the Makefile.in
cp Makefile.am Makefile.in
sed -i "s/@INSTALL@/${INSTALL}/g"	Makefile.in
sed -i "s/@UPDATE@/${UPDATE}/g"		Makefile.in
sed -i "s/@UPGRADE@/${UPGRADE}/g"	Makefile.in


cp fakeAP.conf.example fakeAP.conf
ls /sys/class/net  | grep wlan | while read line
do
	if [ x"$(iw ${line} info >/dev/null)" = x"" ]; then
		sed -i "s/MACPREFIX=.*/MACPREFIX=\"$(cat /sys/class/net/${line}/address)\"/g" fakeAP.conf
		break
	fi
done
MACPREFIX=$(cat fakeAP.conf | grep MACPREFIX | cut -d '"' -f 2)
check MACPREFIX "${MACPREFIX}"


end=`date +%s`
echo 'configure' finished successfully \($(date -d @$((end-start)) -u +%Mm:%Ss)\)
